<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Realiza una acumulaci&oacute;n usando el framework de acumulaci&oacute;n</title>

 </head>
 <body><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="class.mongocollection.html">MongoCollection</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="mongocollection.aggregatecursor.html">MongoCollection::aggregateCursor</a></div>
 <div class="up"><a href="class.mongocollection.html">MongoCollection</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div><hr /><div id="mongocollection.aggregate" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">MongoCollection::aggregate</h1>
  <p class="verinfo">(PECL mongo &gt;=1.3.0)</p><p class="refpurpose"><span class="refname">MongoCollection::aggregate</span> &mdash; <span class="dc-title">Realiza una acumulación usando el framework de acumulación</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-mongocollection.aggregate-description">
  <h3 class="title">Descripción</h3>
  <div class="methodsynopsis dc-description">
   <span class="modifier">public</span> <span class="type">array</span> <span class="methodname"><strong>MongoCollection::aggregate</strong></span>
    ( <span class="methodparam"><span class="type">array</span> <code class="parameter">$pipeline</code></span>
   [, <span class="methodparam"><span class="type">array</span> <code class="parameter">$options</code></span>
  ] )</div>

  <div class="methodsynopsis dc-description">
   <span class="modifier">public</span> <span class="type">array</span> <span class="methodname"><strong>MongoCollection::aggregate</strong></span>
    ( <span class="methodparam"><span class="type">array</span> <code class="parameter">$op</code></span>
   [, <span class="methodparam"><span class="type">array</span> <code class="parameter">$op</code></span>
   [, <span class="methodparam"><span class="type">array</span> <code class="parameter">$...</code></span>
  ]] )</div>

  <p class="para rdfs-comment">
   El
   <a href="http://docs.mongodb.org/manual/core/aggregation-pipeline/" class="link external">&raquo;&nbsp;framework de agregación </a>
   de MongoDB proporciona medios para calcular valores acumulados sin tener que usar
   MapReduce. Aunque MapReduce es potente, a menudo es más dificultoso de lo
   necesario para muchas tareas sencillas de acumulación, tales como totalizar o hallar la media
   de valores de campos.
  </p>
  <p class="para">
   Este método acepta tanto una cantidad variable de operadores de tubería como un
   único array de dichos operadores constituyendo la tubería.
  </p>
 </div>

 
 <div class="refsect1 parameters" id="refsect1-mongocollection.aggregate-parameters">
  <h3 class="title">Parámetros</h3>
  <dl>

   
    <dt>
<code class="parameter">pipeline</code></dt>

    <dd>

     <p class="para">
      Un array de operadores de tubería.
     </p>
    </dd>

   
   
    <dt>
<code class="parameter">options</code></dt>

    <dd>

     <p class="para">Opciones para el comando de acumulación. Las opciones válidas son:</p>
     <ul class="itemizedlist">
      <li class="listitem">
       <p class="para"><em>&quot;allowDiskUse&quot;</em></p>
       <p class="para">Permitir que la agregación pueda escribir ficheros temporales</p>
      </li>
      <li class="listitem">
       <p class="para"><em>&quot;cursor&quot;</em></p>
       <p class="para">
        Opciones para controlar la creación del objeto cursor. Esta opción
        causa que el comando devuelva un documento de resultados apto para construir
        un <a href="class.mongocommandcursor.html" class="classname">MongoCommandCursor</a>. Si fuera necesario
        usar esta opción, se debería considerar el uso
        <span class="methodname"><a href="mongocollection.aggregatecursor.html" class="methodname">MongoCollection::aggregateCursor()</a></span>.
       </p>
      </li>
      <li class="listitem">
       <p class="para"><em>&quot;explain&quot;</em></p>
       <p class="para">Devuelve información sobre el procesamiento de la tubería.</p>
      </li>
      <li class="listitem"><p class="para"><em>&quot;maxTimeMS&quot;</em></p><p class="para">Especifica un tiempo límite acumulativo en milisegundos para procesar la operación en el servdiro (no incluye el tiempo improductivo). Si la operación no la completa el servidor dentro del período de tiempo límite, se lanzará una <a href="class.mongoexecutiontimeoutexception.html" class="classname">MongoExecutionTimeoutException</a>.</p></li>
     </ul>
    </dd>

   
  </dl>

  <p class="para">Or</p>
  <dl>

   
    <dt>
<code class="parameter">op</code></dt>

    <dd>

     <p class="para">
      Primer operador de tubería.
     </p>
    </dd>

   
   
    <dt>
<code class="parameter">op</code></dt>

    <dd>

     <p class="para">
      Segundo operador de tubería.
     </p>
    </dd>

   
   
    <dt>
<code class="parameter">...</code></dt>

    <dd>

     <p class="para">
      Operadores de tubería adicionales.
     </p>
    </dd>

   
  </dl>

 </div>

 
 <div class="refsect1 returnvalues" id="refsect1-mongocollection.aggregate-returnvalues">
  <h3 class="title">Valores devueltos</h3>
  <p class="para">
   Un array con el resultado de la acumulación. <var class="varname"><var class="varname">ok</var></var> será
   establecido a <em>1</em> en caso de éxito, <em>0</em> en caso de error.
  </p>
 </div>

 
 <div class="refsect1 errors" id="refsect1-mongocollection.aggregate-errors">
  <h3 class="title">Errores/Excepciones</h3>
  <p class="para">
   Cuando ocurre un error se devuelve un array con las siguientes claves:
   <ul class="itemizedlist">
    <li class="listitem">
     <span class="simpara">
      <var class="varname"><var class="varname">errmsg</var></var> - contiene la razón del fallo
     </span>
    </li>
    <li class="listitem">
     <span class="simpara">
      <var class="varname"><var class="varname">code</var></var> - el código de error del fallo
     </span>
    </li>
    <li class="listitem">
     <span class="simpara">
      <var class="varname"><var class="varname">ok</var></var> - será establecido a 0.
     </span>
    </li>
   </ul>
  </p>
 </div>

 
 <div class="refsect1 changelog" id="refsect1-mongocollection.aggregate-changelog">
  <h3 class="title">Historial de cambios</h3>
  <table class="doctable informaltable">
   
    <thead>
     <tr>
      <th>Versión</th>
      <th>Descripción</th>
     </tr>

    </thead>

    <tbody class="tbody">
     <tr>
      <td>1.5.0</td>
      <td>
       Se añadió el parámetro opcional <code class="parameter">options</code>
      </td>
     </tr>

    </tbody>
   
  </table>

 </div>

 
 <div class="refsect1 examples" id="refsect1-mongocollection.aggregate-examples">
  <h3 class="title">Ejemplos</h3>
  <div class="example" id="mongocollection.aggregate.example.basic">
   <p><strong>Ejemplo #1 Ejemplo de <span class="methodname"><strong>MongoCollection::aggregate()</strong></span></strong></p>
   <div class="example-contents"><p>
    El siguiente ejemplo de operación acumulativa pivota datos para crear un conjunto de
    nombres de autores agrupados por etiquetas aplicadas a un artículo. Se llama al framework de
    acumulación usando el siguiente comando:
   </p></div>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$m&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">MongoClient</span><span style="color: #007700">(</span><span style="color: #DD0000">"localhost"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$c&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$m</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">selectDB</span><span style="color: #007700">(</span><span style="color: #DD0000">"examples"</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">selectCollection</span><span style="color: #007700">(</span><span style="color: #DD0000">"article"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$datos&nbsp;</span><span style="color: #007700">=&nbsp;array&nbsp;(<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'title'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'this&nbsp;is&nbsp;my&nbsp;title'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'author'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'bob'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'posted'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;new&nbsp;</span><span style="color: #0000BB">MongoDate</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'pageViews'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">5</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'tags'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array&nbsp;(&nbsp;</span><span style="color: #DD0000">'fun'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'good'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'fun'&nbsp;</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'comments'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array&nbsp;(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;array&nbsp;(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'author'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'joe'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'text'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'this&nbsp;is&nbsp;cool'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;array&nbsp;(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'author'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'sam'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'text'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'this&nbsp;is&nbsp;bad'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),<br />&nbsp;&nbsp;&nbsp;&nbsp;),<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'other'&nbsp;</span><span style="color: #007700">=&gt;array&nbsp;(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'foo'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">5</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;),<br />);<br /></span><span style="color: #0000BB">$d&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$c</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">insert</span><span style="color: #007700">(</span><span style="color: #0000BB">$datos</span><span style="color: #007700">,&nbsp;array(</span><span style="color: #DD0000">"w"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">));<br /><br /></span><span style="color: #0000BB">$ops&nbsp;</span><span style="color: #007700">=&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'$project'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"author"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"tags"&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br />&nbsp;&nbsp;&nbsp;&nbsp;),<br />&nbsp;&nbsp;&nbsp;&nbsp;array(</span><span style="color: #DD0000">'$unwind'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'$tags'</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'$group'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"_id"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">"tags"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'$tags'</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"authors"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">'$addToSet'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'$author'</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),<br />&nbsp;&nbsp;&nbsp;&nbsp;),<br />);<br /></span><span style="color: #0000BB">$resultados&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$c</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">aggregate</span><span style="color: #007700">(</span><span style="color: #0000BB">$ops</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$resultados</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

   <div class="example-contents"><p>El resultado del ejemplo sería:</p></div>
   <div class="example-contents screen">
<div class="cdata"><pre>
array(2) {
  [&quot;result&quot;]=&gt;
  array(2) {
    [0]=&gt;
    array(2) {
      [&quot;_id&quot;]=&gt;
      array(1) {
        [&quot;tags&quot;]=&gt;
        string(4) &quot;good&quot;
      }
      [&quot;authors&quot;]=&gt;
      array(1) {
        [0]=&gt;
        string(3) &quot;bob&quot;
      }
    }
    [1]=&gt;
    array(2) {
      [&quot;_id&quot;]=&gt;
      array(1) {
        [&quot;tags&quot;]=&gt;
        string(3) &quot;fun&quot;
      }
      [&quot;authors&quot;]=&gt;
      array(1) {
        [0]=&gt;
        string(3) &quot;bob&quot;
      }
    }
  }
  [&quot;ok&quot;]=&gt;
  float(1)
}
</pre></div>
   </div>
  </div>
  
  <p class="para">
   El siguiente ejemplo usa el <a href="http://media.mongodb.org/zips.json" class="link external">&raquo;&nbsp;conjunto de datos de códigos zip</a>.
   Utilice mongoimport para cargar este conjunto de datos en una instancia de mongod.
  </p>
  
  <div class="example" id="mongocollection.aggregate.example.zipcode.population">
   <p><strong>Ejemplo #2 Ejemplo de <span class="methodname"><strong>MongoCollection::aggregate()</strong></span></strong></p>
   <div class="example-contents"><p>
    Para devolver todos los estados con una población de más de 10 millones, se usa la siguiente operación acumulativa:
   </p></div>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$m&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">MongoClient</span><span style="color: #007700">(</span><span style="color: #DD0000">"localhost"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$c&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$m</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">selectDB</span><span style="color: #007700">(</span><span style="color: #DD0000">"test"</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">selectCollection</span><span style="color: #007700">(</span><span style="color: #DD0000">"zips"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$tubería&nbsp;</span><span style="color: #007700">=&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'$group'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">'state'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'$state'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'city'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'$city'&nbsp;</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'pop'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">'$sum'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'$pop'&nbsp;</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br />&nbsp;&nbsp;&nbsp;&nbsp;),<br />&nbsp;&nbsp;&nbsp;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'$group'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'$_id.state'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'avgCityPop'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">'$avg'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'$pop'</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br />&nbsp;&nbsp;&nbsp;&nbsp;)<br />);<br /></span><span style="color: #0000BB">$salida&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$c</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">aggregate</span><span style="color: #007700">(</span><span style="color: #0000BB">$tubería</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$salida</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

   <div class="example-contents"><p>El resultado del ejemplo 
sería algo similar a:</p></div>
   <div class="example-contents screen">
<div class="cdata"><pre>
array(2) {
  [&quot;result&quot;]=&gt;
  array(7) {
    [0]=&gt;
    array(2) {
      [&quot;_id&quot;]=&gt;
      string(2) &quot;TX&quot;
      [&quot;totalPop&quot;]=&gt;
      int(16986510)
    }
    [1]=&gt;
    array(2) {
      [&quot;_id&quot;]=&gt;
      string(2) &quot;PA&quot;
      [&quot;totalPop&quot;]=&gt;
      int(11881643)
    }
    [2]=&gt;
    array(2) {
      [&quot;_id&quot;]=&gt;
      string(2) &quot;NY&quot;
      [&quot;totalPop&quot;]=&gt;
      int(17990455)
    }
    [3]=&gt;
    array(2) {
      [&quot;_id&quot;]=&gt;
      string(2) &quot;IL&quot;
      [&quot;totalPop&quot;]=&gt;
      int(11430602)
    }
    [4]=&gt;
    array(2) {
      [&quot;_id&quot;]=&gt;
      string(2) &quot;CA&quot;
      [&quot;totalPop&quot;]=&gt;
      int(29760021)
    }
    [5]=&gt;
    array(2) {
      [&quot;_id&quot;]=&gt;
      string(2) &quot;OH&quot;
      [&quot;totalPop&quot;]=&gt;
      int(10847115)
    }
    [6]=&gt;
    array(2) {
      [&quot;_id&quot;]=&gt;
      string(2) &quot;FL&quot;
      [&quot;totalPop&quot;]=&gt;
      int(12937926)
    }
  }
  [&quot;ok&quot;]=&gt;
  float(1)
}
</pre></div>
   </div>
  </div>
  
  <div class="example" id="mongocollection.aggregate.example.zipcode.population.average">
   <p><strong>Ejemplo #3 Ejemplo de <span class="methodname"><strong>MongoCollection::aggregate()</strong></span></strong></p>
   <div class="example-contents"><p>
    Para devolver la población media de las ciudades de cada estado, use la siguiente operación acumulativa:
   </p></div>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$m&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">MongoClient</span><span style="color: #007700">(</span><span style="color: #DD0000">"localhost"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$c&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$m</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">selectDB</span><span style="color: #007700">(</span><span style="color: #DD0000">"test"</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">selectCollection</span><span style="color: #007700">(</span><span style="color: #DD0000">"zips"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$salida&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$c</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">aggregate</span><span style="color: #007700">(<br />&nbsp;&nbsp;&nbsp;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'$group'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">'state'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'$state'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'city'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'$city'&nbsp;</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'pop'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">'$sum'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'$pop'&nbsp;</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br />&nbsp;&nbsp;&nbsp;&nbsp;),<br />&nbsp;&nbsp;&nbsp;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'$group'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'$_id.state'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'avgCityPop'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">'$avg'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'$pop'</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br />&nbsp;&nbsp;&nbsp;&nbsp;)<br />);<br /><br /></span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$salida</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

   <div class="example-contents"><p>El resultado del ejemplo 
sería algo similar a:</p></div>
   <div class="example-contents screen">
<div class="cdata"><pre>
array(2) {
  [&quot;result&quot;]=&gt;
  array(51) {
    [0]=&gt;
    array(2) {
      [&quot;_id&quot;]=&gt;
      string(2) &quot;DC&quot;
      [&quot;avgCityPop&quot;]=&gt;
      float(303450)
    }
    [1]=&gt;
    array(2) {
      [&quot;_id&quot;]=&gt;
      string(2) &quot;DE&quot;
      [&quot;avgCityPop&quot;]=&gt;
      float(14481.913043478)
    }
...
    [49]=&gt;
    array(2) {
      [&quot;_id&quot;]=&gt;
      string(2) &quot;WI&quot;
      [&quot;avgCityPop&quot;]=&gt;
      float(7323.0074850299)
    }
    [50]=&gt;
    array(2) {
      [&quot;_id&quot;]=&gt;
      string(2) &quot;WV&quot;
      [&quot;avgCityPop&quot;]=&gt;
      float(2759.1953846154)
    }
  }
  [&quot;ok&quot;]=&gt;
  float(1)
}
</pre></div>
   </div>
  </div>
  
  <div class="example" id="mongocollection.aggregate.example.zipcode.explain">
   <p><strong>Ejemplo #4 <span class="methodname"><strong>MongoCollection::aggregate()</strong></span> con opciones de comandos</strong></p>
   <div class="example-contents"><p>
    Para devolver información sobre cómo será procesada la tubería, se usa la opción de comando <em>explain</em>
   </p></div>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$m&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">MongoClient</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$c&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$m</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">selectDB</span><span style="color: #007700">(</span><span style="color: #DD0000">"test"</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">selectCollection</span><span style="color: #007700">(</span><span style="color: #DD0000">"zips"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$tubería&nbsp;</span><span style="color: #007700">=&nbsp;array(array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'$group'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'$state'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'totalPop'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">'$sum'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'$pop'</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),<br />&nbsp;&nbsp;&nbsp;&nbsp;),<br />&nbsp;&nbsp;&nbsp;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'$match'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">'totalPop'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">'$gte'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">10</span><span style="color: #007700">*</span><span style="color: #0000BB">1000</span><span style="color: #007700">*</span><span style="color: #0000BB">1000</span><span style="color: #007700">)),<br />&nbsp;&nbsp;&nbsp;&nbsp;),<br />&nbsp;&nbsp;&nbsp;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'$sort'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">"totalPop"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;-</span><span style="color: #0000BB">1</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;),<br />);<br /><br /></span><span style="color: #0000BB">$opciones&nbsp;</span><span style="color: #007700">=&nbsp;array(</span><span style="color: #DD0000">"explain"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$salida&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$c</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">aggregate</span><span style="color: #007700">(</span><span style="color: #0000BB">$tubería</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$opciones</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$salida</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

   <div class="example-contents"><p>El resultado del ejemplo 
sería algo similar a:</p></div>
   <div class="example-contents screen">
<div class="cdata"><pre>
array(2) {
  [&quot;stages&quot;]=&gt;
  array(4) {
    [0]=&gt;
    array(1) {
      [&quot;$cursor&quot;]=&gt;
      array(3) {
        [&quot;query&quot;]=&gt;
        array(0) {
        }
        [&quot;fields&quot;]=&gt;
        array(3) {
          [&quot;pop&quot;]=&gt;
          int(1)
          [&quot;state&quot;]=&gt;
          int(1)
          [&quot;_id&quot;]=&gt;
          int(0)
        }
        [&quot;plan&quot;]=&gt;
        array(4) {
          [&quot;cursor&quot;]=&gt;
          string(11) &quot;BasicCursor&quot;
          [&quot;isMultiKey&quot;]=&gt;
          bool(false)
          [&quot;scanAndOrder&quot;]=&gt;
          bool(false)
          [&quot;allPlans&quot;]=&gt;
          array(1) {
            [0]=&gt;
            array(3) {
              [&quot;cursor&quot;]=&gt;
              string(11) &quot;BasicCursor&quot;
              [&quot;isMultiKey&quot;]=&gt;
              bool(false)
              [&quot;scanAndOrder&quot;]=&gt;
              bool(false)
            }
          }
        }
      }
    }
    [1]=&gt;
    array(1) {
      [&quot;$group&quot;]=&gt;
      array(2) {
        [&quot;_id&quot;]=&gt;
        string(6) &quot;$state&quot;
        [&quot;totalPop&quot;]=&gt;
        array(1) {
          [&quot;$sum&quot;]=&gt;
          string(4) &quot;$pop&quot;
        }
      }
    }
    [2]=&gt;
    array(1) {
      [&quot;$match&quot;]=&gt;
      array(1) {
        [&quot;totalPop&quot;]=&gt;
        array(1) {
          [&quot;$gte&quot;]=&gt;
          int(10000000)
        }
      }
    }
    [3]=&gt;
    array(1) {
      [&quot;$sort&quot;]=&gt;
      array(1) {
        [&quot;sortKey&quot;]=&gt;
        array(1) {
          [&quot;totalPop&quot;]=&gt;
          int(-1)
        }
      }
    }
  }
  [&quot;ok&quot;]=&gt;
  float(1)
}
</pre></div>
   </div>
  </div>
  
 </div>

 
 <div class="refsect1 seealso" id="refsect1-mongocollection.aggregate-seealso">
  <h3 class="title">Ver también</h3>
  <ul class="simplelist">
   <li class="member"><span class="methodname"><a href="mongocollection.aggregatecursor.html" class="methodname" rel="rdfs-seeAlso">MongoCollection::aggregateCursor()</a> - Ejecutar un comando de tuber&iacute;a acumulador y recuperar los resultados mediante un cursor</span></li>
   <li class="member">El <a href="http://docs.mongodb.org/manual/core/aggregation-pipeline/" class="link external">&raquo;&nbsp;framework de acumulación</a> de MongoDB</li>
  </ul>
 </div>

 
</div><hr /><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="class.mongocollection.html">MongoCollection</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="mongocollection.aggregatecursor.html">MongoCollection::aggregateCursor</a></div>
 <div class="up"><a href="class.mongocollection.html">MongoCollection</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div></body></html>
